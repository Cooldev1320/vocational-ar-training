<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
		<meta name="HandheldFriendly" content="true" />
	  </head>
	<body>
		<button id="start" style="display: block; position: absolute; background-color: #FF6666; width: 100%; height: 100%; top: 0px; left: 0px; text-align: center; font-family: Arial, Helvetica, sans-serif; font-size: 10vh; color: white; border: none;">
			Start AR
		</button>
		<div id="debug" style="position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.8); color: lime; padding: 10px; font-family: monospace; font-size: 12px; z-index: 1000; display: none; max-width: 90%; max-height: 200px; overflow-y: auto;"></div>
		
		<!-- Eruda mobile console -->
		<script src="https://cdn.jsdelivr.net/npm/eruda"></script>
		<script>eruda.init();</script>
		
        <script async src="./lib/es-module-shims.js"></script>
        <script type="importmap">
			{
				"imports": {
					"three": "./lib/three.module.js",
					"three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
				}
			}
		</script>
        <script type="module">
            import {ARRenderer, Cursor} from "../src/enva.ts";
            import {GLTFLoader} from "three/addons/loaders/GLTFLoader.js";
            import {HemisphereLight, DirectionalLight} from "three";

            const debugDiv = document.getElementById('debug');
            let debugLines = [];
            
            function log(msg) {
                console.log(msg);
                const timestamp = new Date().toLocaleTimeString();
                debugLines.unshift(`[${timestamp}] ${msg}`);
                if (debugLines.length > 10) debugLines.pop();
                debugDiv.innerHTML = debugLines.join('<br>');
            }

            (async function () {
                log('ðŸ”· Initializing...');
                
                const renderer = new ARRenderer({
                    domOverlay: true,
                    hitTest: true
                });

                log('âœ… Renderer created');

                let cursor = new Cursor();
                renderer.scene.add(cursor);
                log('âœ… Cursor added');

                // BEST PRACTICE: HemisphereLight + DirectionalLight
                const hemiLight = new HemisphereLight(0xffffff, 0x444444, 1.0);
                hemiLight.position.set(0, 20, 0);
                renderer.scene.add(hemiLight);
                
                const dirLight = new DirectionalLight(0xffffff, 1.0);
                dirLight.position.set(5, 10, 7.5);
                dirLight.castShadow = true;
                renderer.scene.add(dirLight);
                
                log('ðŸ’¡ Lights: HemisphereLight + DirectionalLight');

                // Load boy model
                let boyModel = null;
                let modelLoaded = false;
                log('ðŸ“¦ Loading /models/boy.glb...');
                
                const loader = new GLTFLoader();
                loader.load(
                    '/models/boy.glb',
                    (gltf) => {
                        boyModel = gltf.scene;
                        boyModel.scale.set(0.3, 0.3, 0.3);
                        
                        // Setup materials and shadows
                        boyModel.traverse((child) => {
                            if (child.isMesh) {
                                child.castShadow = true;
                                child.receiveShadow = true;
                            }
                        });
                        
                        modelLoaded = true;
                        log(`âœ… MODEL LOADED! Meshes: ${boyModel.children.length}`);
                    },
                    (progress) => {
                        const percent = Math.round((progress.loaded / progress.total) * 100);
                        log(`Loading: ${percent}%`);
                    },
                    (error) => {
                        log(`âŒ ERROR: ${error.message}`);
                        console.error('Full error:', error);
                    }
                );

                // Double tap to place (same as cursor.html)
                let placedCount = 0;
                renderer.domContainer.ondblclick = function(event) {
                    log(`ðŸ–±ï¸ Tap! Cursor:${cursor.visible} Model:${modelLoaded}`);
                    
                    if (!modelLoaded) {
                        log('âš ï¸ Model loading...');
                        return;
                    }
                    
                    if (!cursor.visible) {
                        log('âš ï¸ Find surface first!');
                        return;
                    }
                    
                    if (cursor.visible && boyModel) {
                        // Deep clone for GLTF models
                        let modelClone = boyModel.clone(true);
                        modelClone.position.copy(cursor.position);
                        modelClone.position.y += 0.05;
                        
                        renderer.scene.add(modelClone);
                        placedCount++;
                        
                        const pos = modelClone.position;
                        log(`âœ… PLACED #${placedCount} at (${pos.x.toFixed(2)}, ${pos.y.toFixed(2)}, ${pos.z.toFixed(2)})`);
                    }
                };

                var button = document.getElementById("start");
                button.onclick = async () =>
                {
                    log('ðŸš€ Starting AR...');
                    await renderer.start();
                    button.style.display = 'none';
                    debugDiv.style.display = 'block';
                    log('âœ… AR started! Double-tap to place.');
                };
            })();
        </script>
	</body>
</html>
